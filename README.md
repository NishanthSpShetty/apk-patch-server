## patch-server
_Project born from hackathon_

server to store and generate patch files for apk files using bsdiff

----

bsdiff/bspatch is a library for generating delta patch files and applying patch files.

This library has two components

### `bsdiff` generates the delta file or patch file for the given old file and new file, the generated file then later can be used to update old binaries to new one.

### `bspatch` is to patch the old files using the patch/delta file generated by `bsdiff`. 

---
### `patch-server` uses these library to provide the patch file for the new apk releases, also the server will act as APK repo.

## how it works ?
 * Upload apk file with meta data such as app name, version via rest endpoints
 * server will store the apk file and make an entry in the system
    and performs following task
    1. if uploaded app name is non existing, server will create new entry in the system and ack client request.
    2. if app is already exist in the system, system will make and entry for apk update, and keeps the new apk in repo, ack the user and trigger the event for patch generator.
    patch generator will query the system for all the releases prior to the current updates and starts generating delta/patch file for all the apk versions.
* When user requests for the update via REST endpointd, system will check the requested APK installed version and laest version in the repo, if present respond with patch file details if not repsond with proper message.
* if the server responds with the patch details, download the file from the server and using `bspatch` update the apk and reinstall.


---
The server can be used as apk repo for the app which are not hosted in store or app which manages the its own update and upgrades.


## endpoints
* upload APK endpoints
    
```
POST /rest/v1/apk/app/{appName}/upload/file
    
        where {appName} is applicatio name, which is unique for all apk releases.
    
    request body
        upload file as multipart data,
    
    
    response 
        status : 200
        file_id  #returns unique upload file id
```

* update apk meta endpoints
```
POST /rest/v1/apk/app/{appName}/upload/meta/{file_id}
    
        where
        {appName} is applicatio name, which is unique for all apk releases.
        {file_id} file id returned by file upload endpoint.

    Request Body
        {
            
            "name":__APP NAME__,
	         "versionId":__APP_VERSION__,
             "versionDisplayName":__DISPLAY_VERSION_STRING__,
	         "releaseDate":__APP_RELEASE_DATE__,
             "category:"__APP_CATEGORY__, ##games, music etc
        }

    Response Body 
        on succuss
            status : 200 
            {"message":"ok"}

        on failure
            500 : server internal error
            {error msg}
```

* Query for update
```
    GET /rest/v1/apk/app/{appName}/update/{version}

     where
        {appName} is applicatio name
        {version}  current installed APK version 

        Request Body 
            NONE

        Response Body
            {
                "name":__APP NAME__,
	            "version:__APP_VERSION__,
	            "versionDisplayName":__DISPLAY_VERSION_STRING__,
	            "releaseDate":__APP_RELEASE_DATE__,
	            "patchId":__APP_PATCH_ID__,
                "patchFile":__PATCH_FILE_NAME,
            }
```


* download patch endpoint
```
GET /rest/v1/apk/app/{appName}/patch/{patchId}
      where
        {appName} is applicatio name
        {patchId}  patch id returned by the  update query api

        Request Body 
            NONE
        
        Response
            patch file
```


----
*NOTE : version is unique number generated for application, not a display string like 1.2.3*

----

## Patch application using bspatch
    server only contains the delta generation file, to use the application patcher refer another repo, a android application using the bspatch is found in repo ${COMING_SOON}